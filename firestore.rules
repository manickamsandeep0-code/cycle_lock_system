rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to check if user owns the document
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // Helper function to check if user is admin
    function isAdmin() {
      return isAuthenticated() && 
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    // Helper function to check if user is cycle owner
    function isCycleOwner() {
      return isAuthenticated() && 
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'owner';
    }
    
    // Users collection
    match /users/{userId} {
      // Anyone can read user profiles (for displaying renter/owner info)
      allow read: if isAuthenticated();
      
      // Users can only create/update their own profile
      allow create: if isAuthenticated() && request.auth.uid == userId;
      allow update: if isOwner(userId) || isAdmin();
      
      // Only admins can delete users
      allow delete: if isAdmin();
    }
    
    // Cycles collection
    match /cycles/{cycleId} {
      // Anyone authenticated can read cycles
      allow read: if isAuthenticated();
      
      // Only cycle owners can create cycles
      allow create: if isAuthenticated() && 
                      isCycleOwner() && 
                      request.resource.data.ownerId == request.auth.uid;
      
      // Owners can update their own cycles, renters can update during rental
      allow update: if isAuthenticated() && (
        // Owner updating their cycle
        resource.data.ownerId == request.auth.uid ||
        // Renter updating rental status
        (resource.data.currentRenter == request.auth.uid && 
         request.resource.data.diff(resource.data).affectedKeys().hasOnly(['location', 'status', 'rentalEndTime'])) ||
        // Admin can update any cycle
        isAdmin()
      );
      
      // Only owners can delete their cycles (and only if not rented)
      allow delete: if isAuthenticated() && 
                      resource.data.ownerId == request.auth.uid && 
                      resource.data.status != 'rented';
    }
    
    // Rental History collection
    match /rentalHistory/{historyId} {
      // Users can read their own rental history (as renter or owner)
      allow read: if isAuthenticated() && (
        resource.data.renterId == request.auth.uid ||
        resource.data.ownerId == request.auth.uid ||
        isAdmin()
      );
      
      // Only renters can create rental history when completing ride
      allow create: if isAuthenticated() && 
                      request.resource.data.renterId == request.auth.uid;
      
      // No updates to rental history (immutable records)
      allow update: if false;
      
      // Only admins can delete rental history
      allow delete: if isAdmin();
    }
    
    // Reports collection
    match /reports/{reportId} {
      // Owners and admins can read reports
      allow read: if isAuthenticated() && (
        resource.data.reporterId == request.auth.uid ||
        isAdmin()
      );
      
      // Owners can create reports about renters
      allow create: if isAuthenticated() && 
                      isCycleOwner() && 
                      request.resource.data.reporterId == request.auth.uid;
      
      // Only admins can update reports (for resolution)
      allow update: if isAdmin();
      
      // Only admins can delete reports
      allow delete: if isAdmin();
    }
    
    // Transactions collection (payments)
    match /transactions/{transactionId} {
      // Users can only read their own transactions
      allow read: if isAuthenticated() && 
                    resource.data.userId == request.auth.uid;
      
      // System/backend creates transactions, not clients
      allow create: if false; // Should be created via Cloud Functions
      
      // No client-side updates to transactions
      allow update: if false; // Should be updated via Cloud Functions
      
      // No deletions
      allow delete: if false;
    }
    
    // Refunds collection
    match /refunds/{refundId} {
      // Users can read their own refunds
      allow read: if isAuthenticated();
      
      // Only admins can create refunds
      allow create: if isAdmin();
      
      // Only admins can update refund status
      allow update: if isAdmin();
      
      // No deletions
      allow delete: if false;
    }
    
    // Damage Reports collection
    match /damageReports/{reportId} {
      // Renters, owners, and admins can read damage reports
      allow read: if isAuthenticated() && (
        resource.data.reporterId == request.auth.uid ||
        resource.data.cycleOwnerId == request.auth.uid ||
        isAdmin()
      );
      
      // Renters can report damage
      allow create: if isAuthenticated() && 
                      request.resource.data.reporterId == request.auth.uid;
      
      // Owners can update status of their cycle's damage reports
      allow update: if isAuthenticated() && (
        resource.data.cycleOwnerId == request.auth.uid ||
        isAdmin()
      );
      
      // Only admins can delete
      allow delete: if isAdmin();
    }
    
    // Default deny all
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
