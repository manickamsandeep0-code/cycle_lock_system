{
  "rules": {
    "locks": {
      "$lockId": {
        // Anyone authenticated can read lock status
        ".read": "auth != null",
        
        // Only authenticated users can write lock commands
        // In production, this should be more restrictive (only app backend or verified users)
        ".write": "auth != null",
        
        ".validate": "newData.hasChildren(['command', 'timestamp', 'status'])",
        
        "command": {
          ".validate": "newData.isString() && (newData.val() == 'lock' || newData.val() == 'unlock' || newData.val() == 'status')"
        },
        
        "status": {
          ".validate": "newData.isString() && (newData.val() == 'locked' || newData.val() == 'unlocked' || newData.val() == 'error' || newData.val() == 'offline')"
        },
        
        "timestamp": {
          ".validate": "newData.isNumber()"
        },
        
        "renterId": {
          ".validate": "newData.isString() || newData.val() == null"
        },
        
        "rentalId": {
          ".validate": "newData.isString() || newData.val() == null"
        },
        
        "battery": {
          ".validate": "newData.isNumber() && newData.val() >= 0 && newData.val() <= 100"
        },
        
        "lastUpdated": {
          ".validate": "newData.isString()"
        }
      }
    },
    
    // Location tracking during rentals
    "activeRentals": {
      "$rentalId": {
        ".read": "auth != null",
        ".write": "auth != null",
        
        "cycleId": {
          ".validate": "newData.isString()"
        },
        
        "renterId": {
          ".validate": "newData.isString()"
        },
        
        "locations": {
          "$timestamp": {
            ".validate": "newData.hasChildren(['latitude', 'longitude', 'timestamp'])",
            
            "latitude": {
              ".validate": "newData.isNumber() && newData.val() >= -90 && newData.val() <= 90"
            },
            
            "longitude": {
              ".validate": "newData.isNumber() && newData.val() >= -180 && newData.val() <= 180"
            },
            
            "timestamp": {
              ".validate": "newData.isNumber()"
            }
          }
        }
      }
    },
    
    // Arduino device status
    "devices": {
      "$lockId": {
        ".read": "auth != null",
        ".write": "true", // Allow Arduino to write without auth (use device-specific tokens in production)
        
        "online": {
          ".validate": "newData.isBoolean()"
        },
        
        "lastSeen": {
          ".validate": "newData.isNumber()"
        },
        
        "firmwareVersion": {
          ".validate": "newData.isString()"
        },
        
        "batteryLevel": {
          ".validate": "newData.isNumber() && newData.val() >= 0 && newData.val() <= 100"
        }
      }
    }
  }
}
